Menu="Utilities"
Icon="ddns-go.png"
Title="DDns-Go"
Type="xmenu"
Tabs="true"
Markdown="false"
---

<?php
// ç»Ÿä¸€è¿”å› JSON
function sendResponse($success, $message, $status = null) {
    header('Content-Type: application/json');
    echo json_encode([
        'success' => $success,
        'message' => $message,
        'status'  => $status
    ]);
    exit;
}

// æ‰§è¡Œ rc.ddns-go å‘½ä»¤
function runServiceCommand($cmd) {
    $script = '/etc/rc.d/rc.ddns-go';
    if (!file_exists($script)) {
        return ['success' => false, 'message' => "æœåŠ¡è„šæœ¬ä¸å­˜åœ¨: $script"];
    }
    $output = [];
    $ret = 1;
    exec("/bin/bash $script $cmd 2>&1", $output, $ret);
    return [
        'success' => ($ret === 0),
        'message' => implode("\n", $output),
        'ret'     => $ret
    ];
}

// çŠ¶æ€æ£€æµ‹
function getServiceStatus() {
    exec("bash /etc/rc.d/rc.ddns-go status", $output, $exitCode);

    if ($exitCode === 0) {
        return 'running';
    } else {
        return 'stopped';
    }
}


// å¤„ç† AJAX è¯·æ±‚
if (isset($_GET['action'])) {
    switch ($_GET['action']) {
        case 'statusService':
            $status = getServiceStatus();
            sendResponse(true, "çŠ¶æ€æ£€æµ‹å®Œæˆ", $status);
        case 'startService':
            $res = runServiceCommand('start');
            sendResponse($res['success'], $res['message'], getServiceStatus());
        case 'stopService':
            $res = runServiceCommand('stop');
            sendResponse($res['success'], $res['message'], getServiceStatus());
        case 'restartService':
            $res = runServiceCommand('restart');
            sendResponse($res['success'], $res['message'], getServiceStatus());
        default:
            sendResponse(false, "æœªçŸ¥æ“ä½œ: " . $_GET['action']);
    }
}
?>


<script src="/jquery.min.js"></script>
<style>
    .unraid-card {border: 1px solid #4D4D4D; border-radius: 6px; padding: 18px; margin-bottom: 20px; }
    h3 { margin-top: 0; }
    .info-table { width: 100%; border-collapse: collapse; }
    .info-table td { padding: 6px; vertical-align: middle; }
    .info-table td:first-child { font-weight: bold; width: 160px; color:#d0d0d0; }
    button { cursor: pointer; padding: 8px 12px; border-radius: 4px; margin-right: 10px; }
    #records-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    #records-table th, #records-table td { padding: 8px; border: 1px solid #4D4D4D; text-align: left; }
    #records-table th { background-color: #404040; }
    .running { color: green; }
    .stopped { color: red; }
    .unknown { color: gray; }
</style>


<div class="unraid-card">
    <h3>æœåŠ¡çŠ¶æ€ä¸æ§åˆ¶</h3>
    <p>å½“å‰çŠ¶æ€: <span class="unknown" ><?php echo getServiceStatus();?></span></p>
    <div>
        <button id="startBtn"  onclick="sendAction('startService')">ğŸŸ¢ å¯åŠ¨</button>
        <button id="stopBtn"  onclick="sendAction('stopService')">ğŸ”´ åœæ­¢</button>
        <button id="restartBtn"  onclick="sendAction('restartService')" >ğŸ”„ é‡å¯</button>
        <button onclick="refreshStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
    </div>
</div>

<div class="unraid-card">
    <h3>DNS è®°å½•çŠ¶æ€
        <button id="btn-refresh-records" style="float: right; font-size: 12px; padding: 6px 10px;">ğŸ”„ åˆ·æ–°</button>
    </h3>
    <div id="records-container"><span></span> åŠ è½½ä¸­...</div>
</div>

<script>
function refreshStatus() {
    fetch('?action=statusService')
        .then(res => res.json())
        .then(data => {
            let statusEl = document.getElementById('status');
            let startBtn = document.getElementById('startBtn');
            let stopBtn = document.getElementById('stopBtn');
            let restartBtn = document.getElementById('restartBtn');

            if (data.success) {
                statusEl.innerText = 'å½“å‰çŠ¶æ€: ' + data.status;
                statusEl.className = data.status === 'running' ? 'running' :
                                     data.status === 'stopped' ? 'stopped' : 'unknown';

                if (data.status === 'running') {
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    restartBtn.disabled = false;
                } else {
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    restartBtn.disabled = true;
                }
            } else {
                statusEl.innerText = 'çŠ¶æ€è·å–å¤±è´¥: ' + (data.message || '');
                statusEl.className = 'unknown';
                startBtn.disabled = false;
                stopBtn.disabled = true;
                restartBtn.disabled = true;
            }
        })
        .catch(err => {
            console.error(err);
        });
}

function sendAction(action) {
    fetch('?action=' + action)
        .then(res => res.json())
        .then(data => {
            alert(data.message || (data.success ? 'æ“ä½œæˆåŠŸ' : 'æ“ä½œå¤±è´¥'));
            refreshStatus();
        })
        .catch(err => {
            console.error(err);
        });
}

window.onload = refreshStatus;
</script>
