Menu="Utilities"
Icon="ddns-go.png"
Title="DDns-Go"
Type="xmenu"
Tabs="true"
Markdown="false"
---


<?php
define('CONFIG_PATH', '/boot/config/plugins/ddns-go/.config.yaml');
define('LOG_PATH', '/var/log/ddns-go.log');
define('SERVICE_SCRIPT', '/etc/rc.d/rc.ddns-go');

function sendResponse($success, $message, $data = null) {
    header('Content-Type: application/json');
    echo json_encode([
        'success' => $success,
        'message' => $message,
        'data'    => $data
    ]);
    exit;
}

function runServiceCommand($cmd) {
    if (!file_exists(SERVICE_SCRIPT)) {
        return ['success' => false, 'message' => "æœåŠ¡è„šæœ¬ä¸å­˜åœ¨: " . SERVICE_SCRIPT];
    }
    exec("/bin/bash " . SERVICE_SCRIPT . " $cmd 2>&1", $output, $ret);
    return [
        'success' => $ret === 0,
        'message' => implode("\n", $output),
        'ret'     => $ret
    ];
}

function getServiceStatus() {
    exec("bash " . SERVICE_SCRIPT . " status", $output, $exitCode);
    return ($exitCode === 0) ? 'running' : 'stopped';
}

function parseDdnsRecords() {
    if (!file_exists(CONFIG_PATH)) return [];

    $domains = [];
    $config_content = file_get_contents(CONFIG_PATH);

    preg_match_all('/(?:ipv4|ipv6):\s*.*?domains:\s*$(.*?)(?=\n\S|$)/ms', $config_content, $matches, PREG_SET_ORDER);
    foreach ($matches as $match) {
        preg_match_all('/-\s*([a-zA-Z0-9\.\-\_]+)/', $match[1], $domain_matches);
        foreach ($domain_matches[1] as $domain) {
            $domains[$domain] = ['domain' => $domain, 'type' => 'N/A', 'ip' => 'N/A', 'status' => 'ç­‰å¾…æ£€æŸ¥'];
        }
    }

    if (empty($domains)) {
        preg_match_all('/-\s*([a-zA-Z0-9\.\-\_]+\.[a-zA-Z]{2,})/', $config_content, $fallback);
        if (!empty($fallback[1])) {
            foreach ($fallback[1] as $d) {
                $domains[$d] = ['domain' => $d, 'type' => 'N/A', 'ip' => 'N/A', 'status' => 'ç­‰å¾…æ£€æŸ¥'];
            }
        }
    }

    if (!file_exists(LOG_PATH)) return array_values($domains);

    $log_lines = file(LOG_PATH, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
    if ($log_lines === false) return array_values($domains);
    $log_lines = array_slice($log_lines, -200);
    $log_lines = array_reverse($log_lines);

    foreach ($domains as $domain => &$data) {
        foreach ($log_lines as $line) {
            if (strpos($line, $domain) !== false) {
                if (preg_match('/Update success.*Current IP:\s*([\d\.:a-fA-F]+)/', $line, $ip_match)) {
                    $data['status'] = 'âœ” æ›´æ–°æˆåŠŸ';
                    $data['ip'] = $ip_match[1];
                    break;
                }
                if (strpos($line, 'IP is up to date') !== false || strpos($line, 'no change') !== false) {
                    $data['status'] = '- æ— éœ€æ›´æ–°';
                    foreach ($log_lines as $prev_line) {
                        if (strpos($prev_line, $domain) !== false && preg_match('/Current IP:\s*([\d\.:a-fA-F]+)/', $prev_line, $ip_match2)) {
                            $data['ip'] = $ip_match2[1];
                            break;
                        }
                    }
                    break;
                }
                if (strpos(strtolower($line), 'failed') !== false || strpos(strtolower($line), 'error') !== false) {
                    $data['status'] = 'âŒ æ›´æ–°å¤±è´¥';
                    $data['ip'] = 'Error';
                    break;
                }
            }
        }
    }
    unset($data);
    return array_values($domains);
}

if (isset($_GET['action'])) {
    switch ($_GET['action']) {
        case 'statusService':
            $status = getServiceStatus();
            sendResponse(true, "çŠ¶æ€æ£€æµ‹å®Œæˆ", ['serviceStatus' => $status]);
            break;
        case 'startService':
            $res = runServiceCommand('start');
            sendResponse($res['success'], $res['message'], ['serviceStatus' => getServiceStatus()]);
            break;
        case 'stopService':
            $res = runServiceCommand('stop');
            sendResponse($res['success'], $res['message'], ['serviceStatus' => getServiceStatus()]);
            break;
        case 'restartService':
            $res = runServiceCommand('restart');
            sendResponse($res['success'], $res['message'], ['serviceStatus' => getServiceStatus()]);
            break;
        case 'getRecords':
            $records = parseDdnsRecords();
            sendResponse(true, "è·å–è®°å½•æˆåŠŸ", ['records' => $records]);
            break;
        default:
            sendResponse(false, "æœªçŸ¥æ“ä½œ: " . $_GET['action']);
    }
}
?>


<script src="/webGui/javascript/jquery.min.js"></script>
<style>
    .unraid-card { background-color: #313131; border: 1px solid #4D4D4D; border-radius: 6px; padding: 18px; margin-bottom: 20px; }
    h3 { margin-top: 0; color: #FFF; }
    .info-table { width: 100%; border-collapse: collapse; }
    .info-table td { padding: 6px; vertical-align: middle; }
    .info-table td:first-child { font-weight: bold; width: 160px; color:#d0d0d0; }
    .status-running { color: #8BC34A; }
    .status-stopped { color: #F44336; }
    .status-ok { color: #8BC34A; }
    .status-nochange { color: #9E9E9E; }
    .status-error { color: #F44336; }
    button { cursor: pointer; padding: 8px 12px; border-radius: 4px; border: 1px solid #636363; background-color: #555; color: #FFF; margin-right: 10px; }
    button:disabled { cursor: not-allowed; background-color: #444; color: #888; }
    #records-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    #records-table th, #records-table td { padding: 8px; border: 1px solid #4D4D4D; text-align: left; }
    #records-table th { background-color: #404040; }
    .spinner { display: inline-block; border: 3px solid #3a3a3a; border-top: 3px solid #9aa7ff; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; vertical-align: middle; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>


<div class="unraid-card">
    <h3>æœåŠ¡çŠ¶æ€ä¸æ§åˆ¶</h3>
    <p>å½“å‰çŠ¶æ€: <span id="service-status" class="spinner">æ£€æµ‹ä¸­...</span></p>
    <div>
        <button id="btn-start" disabled>ğŸŸ¢ å¯åŠ¨</button>
        <button id="btn-stop" disabled>ğŸ”´ åœæ­¢</button>
        <button id="btn-restart" disabled>ğŸ”„ é‡å¯</button>
        <button id="btn-refresh">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
    </div>
</div>

<div class="unraid-card">
    <h3>DNS è®°å½•çŠ¶æ€
        <button id="btn-refresh-records" style="float: right; font-size: 12px; padding: 6px 10px;">ğŸ”„ åˆ·æ–°</button>
    </h3>
    <div id="records-container"><span class="spinner"></span> åŠ è½½ä¸­...</div>
</div>

<script>
$(function(){
    // åˆå§‹åŒ–æŒ‰é’®äº‹ä»¶
    $('#btn-start').click(() => sendAction('startService'));
    $('#btn-stop').click(() => sendAction('stopService'));
    $('#btn-restart').click(() => sendAction('restartService'));
    $('#btn-refresh').click(updateServiceStatus);
    $('#btn-refresh-records').click(loadRecords);

    // åˆå§‹åŠ è½½
    updateServiceStatus();
    loadRecords();

    function updateServiceStatus() {
        setButtonsDisabled(true);
        $('#service-status').html('<span class="spinner"></span> æ£€æµ‹ä¸­...');
        $.getJSON('?action=statusService').done(function(res) {
            if (res.success) {
                let status = res.data.serviceStatus;
                $('#service-status').text(status === 'running' ? 'ğŸŸ¢ è¿è¡Œä¸­' : 'ğŸ”´ å·²åœæ­¢');
                $('#service-status').removeClass('status-running status-stopped')
                                    .addClass(status === 'running' ? 'status-running' : 'status-stopped');
                if (status === 'running') {
                    $('#btn-start').prop('disabled', true);
                    $('#btn-stop,#btn-restart').prop('disabled', false);
                } else {
                    $('#btn-start').prop('disabled', false);
                    $('#btn-stop,#btn-restart').prop('disabled', true);
                }
            } else {
                $('#service-status').text('çŠ¶æ€è·å–å¤±è´¥');
                $('#service-status').removeClass('status-running status-stopped').addClass('status-error');
                setButtonsDisabled(false);
            }
        }).fail(function() {
            $('#service-status').text('è¯·æ±‚é”™è¯¯');
            $('#service-status').removeClass('status-running status-stopped').addClass('status-error');
            setButtonsDisabled(false);
        });
    }

    function setButtonsDisabled(disabled) {
        $('#btn-start,#btn-stop,#btn-restart,#btn-refresh').prop('disabled', disabled);
    }

    function sendAction(action) {
        setButtonsDisabled(true);
        $('#service-status').html('<span class="spinner"></span> æ­£åœ¨å‘é€å‘½ä»¤...');
        $.getJSON('?action=' + action).done(function(res) {
            alert(res.message || (res.success ? 'æ“ä½œæˆåŠŸ' : 'æ“ä½œå¤±è´¥'));
            updateServiceStatus();
        }).fail(function() {
            alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
            updateServiceStatus();
        });
    }

    function loadRecords() {
        $('#records-container').html('<span class="spinner"></span> åŠ è½½ä¸­...');
        $.getJSON('?action=getRecords').done(function(res){
            if(res.success){
                if(res.data.records.length === 0){
                    $('#records-container').html('<div>æœªæ‰¾åˆ°é…ç½®æˆ–æœªé…ç½®åŸŸåã€‚</div>');
                    return;
                }
                let html = '<table id="records-table"><thead><tr><th>åŸŸå</th><th>ç±»å‹</th><th>å½“å‰è§£æ IP</th><th>çŠ¶æ€</th></tr></thead><tbody>';
                res.data.records.forEach(r=>{
                    let cls = r.status.includes('æˆåŠŸ') ? 'status-ok' :
                              (r.status.includes('æ— éœ€') ? 'status-nochange' :
                              (r.status.includes('å¤±è´¥') ? 'status-error' : ''));
                    html += `<tr><td>${r.domain}</td><td>${r.type || '-'}</td><td>${r.ip || '-'}</td><td class="${cls}">${r.status}</td></tr>`;
                });
                html += '</tbody></table>';
                $('#records-container').html(html);
            } else {
                $('#records-container').html('<div>è·å–è®°å½•å¤±è´¥</div>');
            }
        }).fail(function(){
            $('#records-container').html('<div>è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ</div>');
        });
    }
});
</script>
