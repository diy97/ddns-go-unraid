Menu="Utilities"
Icon="ddns-go.png"
Title="DDns-Go"
Type="xmenu"
Tabs="true"
Markdown="false"
---

<?php
// 定义服务脚本路径
define('SERVICE_SCRIPT', '/etc/rc.d/rc.ddns-go');

// 运行服务命令的函数
function runServiceCommand($cmd) {
    $script = escapeshellcmd(SERVICE_SCRIPT);
    $output = [];
    $ret = 0;

    // 通过 /bin/bash 调用，避免直接执行权限问题
    exec("/bin/bash $script $cmd 2>&1", $output, $ret);

    return [
        'success' => ($ret === 0),
        'message' => implode("\n", $output),
        'code'    => $ret
    ];
}

// 检查当前服务状态
function getServiceStatus() {
    $status = runServiceCommand('status');
    return $status['success'] ? 'running' : 'stopped';
}

// 处理 AJAX 请求
if (isset($_GET['action'])) {
    $action = $_GET['action'];
    $response = ['success' => false, 'message' => '未知操作'];

    switch ($action) {
        case 'startService':
            $response = runServiceCommand('start');
            break;

        case 'stopService':
            $response = runServiceCommand('stop');
            break;

        case 'restartService':
            $response = runServiceCommand('restart');
            break;

        case 'statusService':
            $response = ['success' => true, 'status' => getServiceStatus()];
            break;
    }

    header('Content-Type: application/json');
    echo json_encode($response);
    exit;
}
?>


    <script>
        function sendAction(action) {
            fetch('?action=' + action)
                .then(res => res.json())
                .then(data => {
                    alert('执行结果: ' + (data.message || '无输出'));
                    if (action === 'statusService') {
                        document.getElementById('status').innerText = '当前状态: ' + data.status;
                    }
                });
        }
        function refreshStatus() {
            sendAction('statusService');
        }
        window.onload = refreshStatus;
    </script>

    <h1>ddns-go 控制面板</h1>
    <p id="status">当前状态: 检测中...</p>
    <button onclick="sendAction('startService')">启动</button>
    <button onclick="sendAction('stopService')">停止</button>
    <button onclick="sendAction('restartService')">重启</button>
    <button onclick="refreshStatus()">刷新状态</button>

