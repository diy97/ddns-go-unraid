Menu="Utilities"
Icon="ddns-go.png"
Title="DDns-Go"
Type="xmenu"
Tabs="true"
Markdown="false"
---


<?php
header('Content-Type: application/json');

$script = '/etc/rc.d/rc.ddns-go';

function runCmd($cmd) {
    global $script;
    if (!file_exists($script)) {
        return ['success' => false, 'message' => "æ‰¾ä¸åˆ°è„šæœ¬ $script"];
    }
    exec("/bin/bash $script $cmd 2>&1", $out, $ret);
    return ['success' => $ret === 0, 'message' => implode("\n", $out), 'ret' => $ret];
}

function getStatus() {
    global $script;
    exec("/bin/bash $script status 2>&1", $out, $ret);
    return ['status' => ($ret === 0 ? 'running' : 'stopped'), 'output' => $out];
}

$action = $_GET['action'] ?? '';

if (!$action) {
    echo json_encode(['success'=>false,'message'=>'æœªæŒ‡å®šaction']);
    exit;
}

switch ($action) {
    case 'statusService':
        $st = getStatus();
        echo json_encode(['success'=>true, 'status'=>$st['status'], 'output'=>$st['output']]);
        break;
    case 'startService':
    case 'stopService':
    case 'restartService':
        $res = runCmd(str_replace('Service','',$action));
        $st = getStatus();
        echo json_encode([
            'success' => $res['success'],
            'message' => $res['message'],
            'status' => $st['status']
        ]);
        break;
    default:
        echo json_encode(['success'=>false,'message'=>"æœªçŸ¥actionï¼š$action"]);
}
exit;
?>


<script src="/jquery.min.js"></script>
<style>
button { margin-right: 10px; padding: 8px 12px; background: #444; color: #eee; border: none; border-radius: 4px; cursor: pointer; }
button:disabled { background: #666; cursor: not-allowed; }
#status { margin-bottom: 20px; font-weight: bold; }
.status-running { color: #4CAF50; }
.status-stopped { color: #F44336; }
</style>


<h2>ddns-go æœåŠ¡ç®¡ç†</h2>

<p id="status" class="status-unknown">çŠ¶æ€ï¼šæ£€æµ‹ä¸­...</p>

<button id="startBtn" disabled>å¯åŠ¨</button>
<button id="stopBtn" disabled>åœæ­¢</button>
<button id="restartBtn" disabled>é‡å¯</button>
<button id="refreshBtn">åˆ·æ–°çŠ¶æ€</button>

<script>
function log(msg) {
    console.log(msg);
}

function updateButtons(status) {
    if(status === 'running') {
        document.getElementById('startBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;
        document.getElementById('restartBtn').disabled = false;
    } else if(status === 'stopped') {
        document.getElementById('startBtn').disabled = false;
        document.getElementById('stopBtn').disabled = true;
        document.getElementById('restartBtn').disabled = true;
    } else {
        document.getElementById('startBtn').disabled = true;
        document.getElementById('stopBtn').disabled = true;
        document.getElementById('restartBtn').disabled = true;
    }
}

function setStatus(text, cssClass) {
    let statusEl = document.getElementById('status');
    statusEl.textContent = 'çŠ¶æ€ï¼š' + text;
    statusEl.className = cssClass || '';
}

function fetchStatus() {
    setStatus('æ£€æµ‹ä¸­...', '');
    fetch('?action=statusService')
    .then(res=>res.json())
    .then(data=>{
        log('çŠ¶æ€æ£€æµ‹è¿”å›: ' + JSON.stringify(data));
        if(data.success) {
            let st = data.status;
            setStatus(st === 'running' ? 'ğŸŸ¢ è¿è¡Œä¸­' : (st === 'stopped' ? 'ğŸ”´ å·²åœæ­¢' : 'æœªçŸ¥'), 'status-' + st);
            updateButtons(st);
        } else {
            setStatus('çŠ¶æ€è·å–å¤±è´¥: ' + data.message, 'status-stopped');
            updateButtons(null);
        }
    }).catch(err=>{
        log('è¯·æ±‚é”™è¯¯: ' + err);
        setStatus('è¯·æ±‚é”™è¯¯', 'status-stopped');
        updateButtons(null);
    });
}

function sendCommand(action) {
    setStatus('å‘é€å‘½ä»¤ä¸­...', '');
    updateButtons(true);
    fetch('?action=' + action)
    .then(res=>res.json())
    .then(data=>{
        log('å‘½ä»¤è¿”å›: ' + JSON.stringify(data));
        alert(data.message || (data.success ? 'æ“ä½œæˆåŠŸ' : 'æ“ä½œå¤±è´¥'));
        fetchStatus();
    }).catch(err=>{
        log('å‘½ä»¤è¯·æ±‚é”™è¯¯: ' + err);
        alert('è¯·æ±‚å¤±è´¥');
        fetchStatus();
    });
}

document.getElementById('startBtn').onclick = () => sendCommand('startService');
document.getElementById('stopBtn').onclick = () => sendCommand('stopService');
document.getElementById('restartBtn').onclick = () => sendCommand('restartService');
document.getElementById('refreshBtn').onclick = fetchStatus;

window.onload = fetchStatus;
</script>
